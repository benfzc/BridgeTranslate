# 設計文件

## 概述

基於對現有 Chrome 翻譯擴展的分析，發現了架構混亂問題需要整理。本設計提出簡化重構方案，在保持所有現有功能的前提下，整理代碼結構。

### 主要問題

1. **重複代碼：** 3個背景服務實現、重複的API處理邏輯
2. **過度複雜：** 多層API抽象、複雜的排程系統
3. **文件混亂：** 功能分散、命名不一致
4. **未使用代碼：** 舊系統代碼、調試代碼混雜

## 架構

### 重構策略

**保持功能完整性原則：** 所有重構都必須保持現有功能正常運作

#### 1. 背景服務整合
- 保留 `background-hybrid.js` 作為主要實現（功能最完整）
- 移除 `background.js` 和 `background-simple.js`（重複實現）
- 確保所有現有API調用繼續正常工作

#### 2. API客戶端簡化
- 保留現有的 Gemini API 功能
- 合併重複的錯誤處理邏輯
- 維持現有的翻譯品質和速度

#### 3. 翻譯系統優化
- 保留智能排程系統（已證實有效）
- 移除舊的視窗翻譯系統（已被取代）
- 確保翻譯按鈕和進度顯示正常

#### 4. 文件結構整理
- 重新組織文件但保持所有匯入路徑有效
- 統一命名規範但不破壞現有引用
- 移除未使用的測試文件

## 組件和介面

### 需要移除的重複文件

#### 背景服務
- 保留：`background-hybrid.js`（功能最完整）
- 移除：`background.js`、`background-simple.js`

#### 已廢棄系統
- 移除：`viewport-translation-manager.js`（已被智能排程取代）
- 保留：`smart-translation-scheduler.js`（現行系統）

#### 測試和調試文件
- 移除：`tests/debug/` 目錄下的調試文件
- 保留：核心功能測試文件

### 功能保護措施

#### 確保API功能不中斷
- 保持所有現有的API調用介面
- 維持翻譯品質和速度
- 保留錯誤處理機制

#### 確保UI功能正常
- 保持翻譯按鈕的所有功能
- 維持設定頁面的完整性
- 保留彈出視窗的所有控制

#### 確保翻譯流程完整
- 保持智能排程系統
- 維持翻譯進度顯示
- 保留翻譯內容渲染

## 錯誤處理

### 保持現有錯誤處理
- 不修改現有的錯誤處理邏輯
- 只移除重複的錯誤處理代碼
- 確保所有錯誤情況都有適當處理

## 測試策略

### 重構前測試
- 測試所有核心功能正常運作
- 記錄當前的功能行為
- 確保有回滾計劃

### 重構後驗證
- 驗證所有功能仍然正常
- 確保翻譯品質沒有下降
- 檢查性能沒有退化