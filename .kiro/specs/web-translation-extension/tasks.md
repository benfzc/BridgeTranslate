# 實作計劃

- [x] 1. 建立專案結構和基礎配置









  - 創建Chrome Extension的目錄結構
  - 編寫manifest.json配置文件，定義權限和腳本
  - 設定基本的HTML、CSS、JavaScript文件架構
  - _需求: 1.1, 3.1_

- [x] 2. 實作核心資料模型和介面





  - 定義TextSegment、Translation、APIConfiguration等TypeScript介面
  - 創建基本的資料驗證函數
  - 實作設定資料的序列化和反序列化邏輯
  - _需求: 3.2, 3.3_

- [x] 3. 開發翻譯按鈕UI元件




  - 創建浮動翻譯按鈕的HTML和CSS樣式
  - 實作按鈕的顯示/隱藏切換功能
  - 加入按鈕狀態管理（idle、translating、completed、error）
  - 實作進度顯示功能
  - _需求: 1.1, 1.6_

- [x] 4. 建立內容腳本和DOM分析功能



  - 創建content script來分析網頁內容
  - 實作文本節點檢測和段落分割邏輯
  - 開發內容優先級排序功能（標題、段落等）
  - 實作基本的可見區域檢測
  - _需求: 1.2, 2.2, 2.3_

- [x] 5. 實作翻譯渲染器




  - 開發翻譯內容插入功能，保持原始排版
  - 實作中英對照顯示格式
  - 創建翻譯內容的顯示/隱藏切換功能
  - 加入載入指示器和錯誤狀態顯示
  - _需求: 1.4, 1.5, 5.1, 5.3_

- [ ] 6. 開發AI API整合服務
- [x] 6.1 實作Google Gemini API整合（優先 - 有免費額度）



  - 創建Google Gemini API客戶端
  - 實作Gemini翻譯請求處理
  - 加入API金鑰驗證功能
  - 實作免費額度使用量追蹤
  - _需求: 1.3, 3.2_

- [ ] 6.2 實作OpenAI GPT API整合
  - 創建OpenAI API客戶端類別
  - 實作GPT翻譯請求和回應處理
  - 加入錯誤處理和重試機制
  - _需求: 1.3, 3.5_

- [ ] 6.3 實作Claude API整合
  - 創建Anthropic Claude API客戶端
  - 實作Claude翻譯請求和回應處理
  - 加入速率限制處理
  - _需求: 1.3, 3.5_

- [ ] 6.4 實作Bing Translator API整合
  - 創建Microsoft Translator API客戶端
  - 實作Bing翻譯請求處理
  - 加入區域設定支援
  - _需求: 1.3_

- [ ] 6.5 實作Google Translate API整合
  - 創建Google Translate API客戶端
  - 實作傳統翻譯服務整合
  - 加入專案ID配置支援
  - _需求: 1.3_

- [ ] 7. 建立翻譯管理器和協調邏輯
  - 創建翻譯管理器來協調不同API服務
  - 實作翻譯請求佇列和批次處理
  - 開發漸進式翻譯顯示邏輯
  - 實作使用量追蹤功能
  - _需求: 2.5, 5.1, 5.2_

- [ ] 8. 實作快取系統
  - 開發基本的翻譯快取機制
  - 實作快取的儲存和檢索功能
  - 創建快取過期和清理邏輯
  - 加入快取統計功能
  - _需求: 2.4_

- [x] 9. 開發設定介面



  - 創建外掛設定頁面的HTML和CSS
  - 實作API服務選擇和金鑰輸入介面
  - 開發設定驗證和儲存功能
  - 實作使用量統計顯示
  - _需求: 3.1, 3.2, 3.4, 2.5_

- [x] 10. 實作背景服務腳本



  - 創建background script來處理跨頁面通訊
  - 實作設定資料的同步和管理
  - 開發API請求的集中處理邏輯
  - 加入錯誤處理和日誌記錄
  - _需求: 3.3, 3.5_

- [x] 11. 加入錯誤處理和使用者回饋
  - 實作API錯誤的使用者友善訊息顯示
  - 開發翻譯失敗的重試功能
  - 創建錯誤狀態的視覺指示
  - 實作網路錯誤的處理邏輯
  - 完善的 DebugHelper 全域錯誤處理系統
  - 完整的 destroy() 方法和資源清理機制
  - _需求: 3.5, 5.4_

- [ ] 12. 開發基本測試套件
  - 創建單元測試來驗證核心功能
  - 實作API整合的模擬測試
  - 開發內容分析功能的測試
  - 創建設定管理的測試案例
  - _需求: 所有需求的驗證_

- [ ] 13. 整合所有元件並進行端到端測試
  - 將所有元件整合到完整的外掛中
  - 測試完整的使用者流程（安裝→設定→翻譯）
  - 驗證所有需求的實作
  - 進行跨瀏覽器相容性測試（Chrome/Edge）
  - _需求: 1.1-1.6, 2.1-2.5, 3.1-3.5, 5.1-5.4_

- [ ] 14. 安全性改進和優化
  - 實作API金鑰的本地加密儲存
  - 添加會話儲存選項（關閉瀏覽器後需重新輸入）
  - 在設定頁面添加安全提醒和最佳實踐說明
  - 實作敏感資料的安全清理機制
  - 加入資料匯出/匯入功能的安全驗證
  - _需求: 3.3 (安全儲存)_

## 智能翻譯排程系統 (Smart Translation Scheduling)

**注意：此系統將取代原有的視窗內翻譯優化方案，採用基於隊列的全頁面智能排程策略**

- [x] 17. 實作 Rate-Limited Translation Queue 核心系統



  - 創建 `RateLimitedTranslationQueue` 類別
  - 實作基於 RPM/TPM/RPD 的速率限制邏輯 (支援 Gemini 2.5 Flash-Lite: 15 RPM)
  - 開發請求歷史追蹤和自動清理機制
  - 實作智能等待時間計算 (`getWaitTime()`)
  - 支援不同 Gemini 模型的動態限制配置
  - _需求: 2.1, 4.1, 4.2_

- [x] 18. 開發智能翻譯排程管理器



  - 創建 `SmartTranslationScheduler` 類別
  - 實作全頁面內容分析和智能分割功能
  - 開發多層次優先級排序算法 (視窗內容 > 標題 > 文檔順序)
  - 實作隊列去重機制 (基於內容 hash 避免重複翻譯)
  - 整合現有的 `ContentAnalyzer` 和 `TranslationRenderer`
  - _需求: 1.1, 2.1, 2.2_

- [x] 19. 實作翻譯進度追蹤和用戶反饋系統
  - 創建進度追蹤機制 (整合在 RateLimitedTranslationQueue 中)
  - 開發即時進度顯示 (當前進度、預估完成時間、隊列狀態)
  - 實作翻譯按鈕動態狀態更新 (進度條、當前翻譯內容預覽)
  - 開發詳細的隊列狀態顯示 (排隊數量、處理速度、剩餘時間)
  - Console 日誌和調試信息系統
  - _需求: 1.6, 5.1, 5.2_

- [ ] 20. 實作 API 配額保護和錯誤處理機制
  - 創建 `RateLimitManager` 類別管理多種 API 限制
  - 實作每日使用量追蹤和自動重置邏輯
  - 開發智能錯誤處理 (指數退避重試、優雅降級、用戶通知)
  - 實作多級配額警告系統 (80%、95% 使用量警告)
  - 開發達到限制時的優雅處理策略 (暫停、排隊、通知)
  - _需求: 4.1, 4.2, 4.3, 5.4_

- [x] 21. 整合新排程系統到現有架構



  - 更新 `WebTranslationContent` 主類別整合新的排程系統
  - 替換現有的 `ViewportTranslationManager` 為 `SmartTranslationScheduler`
  - 更新翻譯按鈕事件處理邏輯 (從滾動觸發改為全頁面排程)
  - 確保與現有快取系統和設定管理的完全兼容性
  - 實作平滑的用戶體驗過渡 (保持現有 UI 行為)
  - _需求: 1.1, 2.1, 3.1_

- [ ] 22. 測試和性能優化
  - 測試不同大小網頁的翻譯性能 (小型文章 vs 長篇文檔)
  - 驗證 API 速率限制的準確性和穩定性
  - 測試各種錯誤情況的處理和恢復機制
  - 優化記憶體使用和隊列管理效率
  - 進行跨瀏覽器兼容性測試 (Chrome, Edge, Firefox)
  - _需求: 所有需求的全面驗證_

- [x] 23. 內容過濾邏輯優化和錯誤修復
  - 修復 `[object Object]` 翻譯顯示問題
  - 修復頁面重載時的 destroy 方法錯誤
  - 大幅簡化內容過濾邏輯，改為基於 HTML 結構的過濾
  - 移除過於嚴格的英文檢測和文本長度限制
  - 提升翻譯覆蓋率，確保更多內容被正確翻譯
  - 創建多個調試工具 (debug-content-filter.html, debug-translation-render.html 等)
  - _需求: 1.2, 2.2, 5.4_

- [x] 24. 實作段落級翻譯優化系統



  - 創建 `ParagraphTranslator` 類別來處理段落級翻譯
  - 實作段落元素檢測功能（`<p>`, `<div>`, `<h1-h6>` 等）
  - 開發純文本提取功能，使用 `textContent` 自動忽略所有HTML標籤
  - 實作段落適用性檢測（長度、內容類型檢查）
  - 創建智能段落分割功能，處理過長內容
  - 實作翻譯結果插入功能，在原段落下方顯示翻譯
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [x] 25. 整合段落級翻譯到現有系統



  - 更新 `SmartTranslationScheduler` 整合段落級翻譯功能
  - 修改內容分析邏輯，以段落為基本翻譯單位
  - 更新翻譯隊列處理邏輯，支援段落級翻譯請求
  - 實作API請求統計功能，顯示段落級翻譯的效率提升
  - 創建段落翻譯的調試和測試工具
  - 確保與現有快取和錯誤處理系統的兼容性
  - _需求: 7.5, 7.6, 2.1_

- [ ] 26. 優化程式碼區塊過濾邏輯
  - 修復複雜程式碼區塊結構的過濾問題（如 `<code class="language-bash">` 內的命令）
  - 增強 `isSpecialElement()` 方法，更準確地檢測程式碼相關元素
  - 實作遞迴檢查，確保程式碼區塊內的所有子元素都被正確過濾
  - 添加程式碼區塊過濾的調試工具和測試案例
  - 確保不會誤過濾包含程式碼的說明文字
  - _需求: 1.2, 2.2, 5.4_

- [x] 27. 修復翻譯按鈕顯示/隱藏切換邏輯錯誤







  - 修復翻譯完成後，再次點擊按鈕無法重新顯示翻譯的問題
  - 分析 `TranslationButtonManager` 和 `WebTranslationContent` 之間的狀態同步問題
  - 修復 `handleTranslationToggle()` 事件處理邏輯，確保翻譯重新顯示功能正常
  - 添加調試日誌追蹤狀態變更，確保問題不再發生
  - _需求: 1.1, 5.1, 5.4_

## 翻譯按鈕隱藏控制功能 (簡化版)

- [x] 28. 在 Popup 中添加按鈕隱藏開關



  - 在現有的 `popup.html` 中添加一個簡單的 checkbox 控制
  - 在 `popup.js` 中添加開關事件處理邏輯
  - 使用 Chrome Storage API 儲存和讀取開關狀態
  - 添加基本的 CSS 樣式
  - _需求: 8.1, 8.7_

- [x] 29. 修改翻譯按鈕支援隱藏/顯示功能




  - 在現有的翻譯按鈕類別中添加 `hide()` 和 `show()` 方法
  - 確保隱藏時不影響翻譯功能的背景處理
  - 保持翻譯內容的顯示狀態不變
  - _需求: 8.2, 8.3, 8.4_

- [x] 30. 實作 Popup 與 Content Script 的基本通訊



  - 在 `popup.js` 中添加向 content script 發送隱藏/顯示訊息的功能
  - 在 `content.js` 中添加接收和處理按鈕隱藏訊息的邏輯
  - 確保狀態在所有分頁間同步
  - _需求: 8.5, 8.6, 8.7_

- [x] 31. 基本測試和整合



  - 測試按鈕隱藏/顯示功能是否正常運作
  - 驗證狀態持久化和跨頁面同步
  - 確保與現有翻譯功能的相容性
  - _需求: 8.1-8.7, 9.1-9.5, 10.1-10.5_

**已完成的舊系統 (將被新系統取代):**
- [x] ~~15. 實作翻譯邊界檢測系統~~ (已完成，但將被新系統取代)
- [x] ~~16. 開發智能滾動翻譯功能~~ (已完成，但將被新系統取代)