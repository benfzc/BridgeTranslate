# æ¶æ§‹é·ç§»ï¼šå¾è¦–çª—ç¿»è­¯åˆ°æ™ºèƒ½æ’ç¨‹ç³»çµ±

## ğŸ“‹ **é·ç§»æ¦‚è¿°**

æˆ‘å€‘æ­£åœ¨å¾åŸºæ–¼æ»¾å‹•è§¸ç™¼çš„è¦–çª—ç¿»è­¯ç³»çµ±é·ç§»åˆ°åŸºæ–¼éšŠåˆ—çš„æ™ºèƒ½æ’ç¨‹ç³»çµ±ï¼Œä»¥è§£æ±º API é…é¡é™åˆ¶å•é¡Œä¸¦æå‡ç”¨æˆ¶é«”é©—ã€‚

## ğŸ”„ **ç³»çµ±å°æ¯”**

### **èˆŠç³»çµ±ï¼šè¦–çª—å…§ç¿»è­¯ (Viewport-based Translation)**

```mermaid
graph TD
    A[ç”¨æˆ¶æ»¾å‹•] --> B[æª¢æ¸¬è¦–çª—è®ŠåŒ–]
    B --> C[æ‰¾åˆ°ç¿»è­¯é‚Šç•Œ]
    C --> D[ç¿»è­¯æ–°é€²å…¥è¦–çª—çš„å…§å®¹]
    D --> E[ç«‹å³ç™¼é€ API è«‹æ±‚]
    E --> F{API é™åˆ¶æª¢æŸ¥}
    F -->|è¶…é™| G[è«‹æ±‚å¤±æ•—]
    F -->|æ­£å¸¸| H[é¡¯ç¤ºç¿»è­¯çµæœ]
```

**å•é¡Œï¼š**
- âŒ ç„¡æ³•æœ‰æ•ˆæ§åˆ¶ API è«‹æ±‚é »ç‡
- âŒ ç”¨æˆ¶å¿«é€Ÿæ»¾å‹•æ™‚æœƒç”¢ç”Ÿå¤§é‡ä¸¦ç™¼è«‹æ±‚
- âŒ å®¹æ˜“è§¸ç™¼ RPM é™åˆ¶å°è‡´ç¿»è­¯å¤±æ•—
- âŒ è¤‡é›œçš„æ»¾å‹•é‚è¼¯å’Œé‚Šç•Œæª¢æ¸¬

### **æ–°ç³»çµ±ï¼šæ™ºèƒ½ç¿»è­¯æ’ç¨‹ (Smart Translation Scheduling)**

```mermaid
graph TD
    A[é»æ“Šç¿»è­¯æŒ‰éˆ•] --> B[åˆ†ææ•´å€‹é é¢]
    B --> C[æ™ºèƒ½å„ªå…ˆç´šæ’åº]
    C --> D[å…¨éƒ¨åŠ å…¥éšŠåˆ—]
    D --> E[éšŠåˆ—è™•ç†å™¨]
    E --> F{æª¢æŸ¥ RPM é™åˆ¶}
    F -->|æœªé”é™åˆ¶| G[ç™¼é€ API è«‹æ±‚]
    F -->|é”åˆ°é™åˆ¶| H[ç­‰å¾…åˆ°ä¸‹ä¸€åˆ†é˜]
    G --> I[ç¿»è­¯å®Œæˆ]
    I --> J[ç«‹å³é¡¯ç¤ºçµæœ]
    J --> K{éšŠåˆ—æ˜¯å¦ç‚ºç©º?}
    K -->|å¦| E
    K -->|æ˜¯| L[ç¿»è­¯å®Œæˆ]
    H --> E
```

**å„ªå‹¢ï¼š**
- âœ… åš´æ ¼éµå®ˆ API é€Ÿç‡é™åˆ¶
- âœ… å¯é æ¸¬çš„ç¿»è­¯é€²åº¦å’Œæ™‚é–“
- âœ… æ™ºèƒ½å„ªå…ˆç´šæ’åº
- âœ… æ›´å¥½çš„ç”¨æˆ¶åé¥‹å’Œæ§åˆ¶

## ğŸ—ï¸ **æ ¸å¿ƒçµ„ä»¶å°æ¯”**

| åŠŸèƒ½ | èˆŠç³»çµ± | æ–°ç³»çµ± |
|------|--------|--------|
| **è§¸ç™¼æ–¹å¼** | æ»¾å‹•äº‹ä»¶ | é»æ“ŠæŒ‰éˆ• |
| **ç¿»è­¯ç¯„åœ** | è¦–çª—å…§å®¹ | å…¨é é¢ |
| **è«‹æ±‚æ§åˆ¶** | ç°¡å–®ç¯€æµ | åš´æ ¼éšŠåˆ— |
| **å„ªå…ˆç´š** | è¦–çª—é †åº | æ™ºèƒ½æ’åº |
| **é€²åº¦åé¥‹** | åŸºæœ¬ç‹€æ…‹ | è©³ç´°é€²åº¦ |
| **éŒ¯èª¤è™•ç†** | åŸºæœ¬é‡è©¦ | æ™ºèƒ½æ¢å¾© |

## ğŸ“¦ **æ–°å¢æ ¸å¿ƒé¡åˆ¥**

### 1. **RateLimitedTranslationQueue**
```javascript
// æ ¸å¿ƒéšŠåˆ—ç®¡ç†å’Œé€Ÿç‡é™åˆ¶
class RateLimitedTranslationQueue {
    constructor(rpmLimit = 15) {
        this.rpmLimit = rpmLimit;
        this.queue = new Map();
        this.requestHistory = [];
        this.isProcessing = false;
    }
    
    enqueue(segment) { /* æ™ºèƒ½å…¥éšŠ */ }
    canSendRequest() { /* RPM æª¢æŸ¥ */ }
    getWaitTime() { /* ç­‰å¾…æ™‚é–“è¨ˆç®— */ }
    startProcessing() { /* é–‹å§‹è™•ç†éšŠåˆ— */ }
}
```

### 2. **SmartTranslationScheduler**
```javascript
// æ™ºèƒ½æ’ç¨‹å’Œå„ªå…ˆç´šç®¡ç†
class SmartTranslationScheduler {
    scheduleFullPageTranslation() { /* å…¨é é¢æ’ç¨‹ */ }
    prioritizeSegments(segments) { /* æ™ºèƒ½æ’åº */ }
    calculatePriority(segment) { /* å„ªå…ˆç´šè¨ˆç®— */ }
}
```

### 3. **TranslationProgressManager**
```javascript
// é€²åº¦è¿½è¹¤å’Œç”¨æˆ¶åé¥‹
class TranslationProgressManager {
    showProgress(current, total, currentSegment) { /* é€²åº¦é¡¯ç¤º */ }
    calculateEstimatedTime(remaining) { /* æ™‚é–“é ä¼° */ }
    updateButtonState(state) { /* æŒ‰éˆ•ç‹€æ…‹ */ }
}
```

### 4. **RateLimitManager**
```javascript
// API é™åˆ¶å’Œé…é¡ç®¡ç†
class RateLimitManager {
    constructor(apiLimits) {
        this.limits = apiLimits; // æ”¯æ´ä¸åŒ Gemini æ¨¡å‹
        this.dailyUsage = { requests: 0, tokens: 0 };
    }
    
    canSendRequest() { /* å¤šé‡é™åˆ¶æª¢æŸ¥ */ }
    recordRequest(tokens) { /* ä½¿ç”¨é‡è¨˜éŒ„ */ }
    getQuotaStatus() { /* é…é¡ç‹€æ…‹ */ }
}
```

## ğŸ”§ **é·ç§»æ­¥é©Ÿ**

### **Phase 1: æ ¸å¿ƒéšŠåˆ—ç³»çµ±**
1. å¯¦ä½œ `RateLimitedTranslationQueue`
2. å¯¦ä½œ `RateLimitManager`
3. åŸºæœ¬çš„é€Ÿç‡é™åˆ¶é‚è¼¯

### **Phase 2: æ™ºèƒ½æ’ç¨‹**
1. å¯¦ä½œ `SmartTranslationScheduler`
2. å…¨é é¢åˆ†æå’Œå„ªå…ˆç´šæ’åº
3. éšŠåˆ—å»é‡å’Œå„ªåŒ–

### **Phase 3: ç”¨æˆ¶é«”é©—**
1. å¯¦ä½œ `TranslationProgressManager`
2. é€²åº¦é¡¯ç¤ºå’Œç”¨æˆ¶æ§åˆ¶
3. éŒ¯èª¤è™•ç†å’Œæ¢å¾©

### **Phase 4: ç³»çµ±æ•´åˆ**
1. æ›´æ–° `WebTranslationContent` ä¸»é¡åˆ¥
2. æ›¿æ›èˆŠçš„ `ViewportTranslationManager`
3. ç¢ºä¿å‘å¾Œå…¼å®¹æ€§

### **Phase 5: æ¸¬è©¦å’Œå„ªåŒ–**
1. åŠŸèƒ½æ¸¬è©¦å’Œæ€§èƒ½æ¸¬è©¦
2. è·¨ç€è¦½å™¨å…¼å®¹æ€§
3. ç”¨æˆ¶é«”é©—å„ªåŒ–

## ğŸ“Š **é æœŸæ”¹é€²**

### **API ä½¿ç”¨æ•ˆç‡**
- **èˆŠç³»çµ±**: ç„¡æ³•æ§åˆ¶ï¼Œå®¹æ˜“è¶…é™
- **æ–°ç³»çµ±**: åš´æ ¼æ§åˆ¶ï¼Œæœ€å¤§åŒ–åˆ©ç”¨é…é¡

### **ç”¨æˆ¶é«”é©—**
- **èˆŠç³»çµ±**: ä¸å¯é æ¸¬çš„ç¿»è­¯é€Ÿåº¦
- **æ–°ç³»çµ±**: å¯é æ¸¬çš„é€²åº¦å’Œå®Œæˆæ™‚é–“

### **ç³»çµ±ç©©å®šæ€§**
- **èˆŠç³»çµ±**: é »ç¹çš„ API éŒ¯èª¤
- **æ–°ç³»çµ±**: ç©©å®šçš„ç¿»è­¯æµç¨‹

### **ç¶­è­·æ€§**
- **èˆŠç³»çµ±**: è¤‡é›œçš„æ»¾å‹•é‚è¼¯
- **æ–°ç³»çµ±**: æ¸…æ™°çš„éšŠåˆ—æ¶æ§‹

## ğŸ¯ **æˆåŠŸæŒ‡æ¨™**

1. **API éŒ¯èª¤ç‡** < 1% (ç›®å‰å¯èƒ½ > 10%)
2. **ç¿»è­¯å®Œæˆç‡** > 95%
3. **ç”¨æˆ¶æ»¿æ„åº¦** - å¯é æ¸¬çš„ç¿»è­¯æ™‚é–“
4. **ç³»çµ±ç©©å®šæ€§** - ç„¡å›  API é™åˆ¶å°è‡´çš„å´©æ½°

---

**é€™å€‹é·ç§»å°‡å¤§å¹…æå‡ç³»çµ±çš„å¯é æ€§å’Œç”¨æˆ¶é«”é©—ï¼** ğŸš€