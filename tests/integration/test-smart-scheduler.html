<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Translation Scheduler Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .test-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .status-panel {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .content-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .high-priority {
            border-left: 4px solid #28a745;
        }
        
        .medium-priority {
            border-left: 4px solid #ffc107;
        }
        
        .low-priority {
            border-left: 4px solid #6c757d;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .viewport-indicator {
            position: fixed;
            top: 50%;
            right: 10px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .translation-content {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-style: italic;
        }
        
        .ad, .advertisement {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .navigation {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="viewport-indicator">視窗指示器</div>
    
    <div class="test-controls">
        <h2>Smart Translation Scheduler 測試</h2>
        
        <div>
            <button id="analyzeBtn">分析頁面內容</button>
            <button id="scheduleBtn">開始智能排程</button>
            <button id="clearBtn">清空隊列</button>
            <button id="pauseBtn">暫停/恢復</button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="progressText">準備就緒</div>
        
        <div class="status-grid">
            <div class="status-panel" id="analysisStatus">
                <strong>分析狀態:</strong><br>
                等待分析...
            </div>
            <div class="status-panel" id="queueStatus">
                <strong>隊列狀態:</strong><br>
                等待排程...
            </div>
        </div>
    </div>

    <!-- 導航區域 (應該被排除) -->
    <div class="navigation">
        <h3>Navigation Menu (Should be excluded)</h3>
        <p>This navigation content should be filtered out by the smart scheduler.</p>
    </div>

    <!-- 廣告區域 (應該被排除) -->
    <div class="ad">
        <strong>Advertisement (Should be excluded)</strong><br>
        This ad content should not be translated.
    </div>

    <!-- 高優先級內容 (視窗內 + 標題) -->
    <div class="content-section high-priority">
        <h1>High Priority: Main Title in Viewport</h1>
        <p>This is a high-priority paragraph that should be translated first because it's in the viewport and contains important content. The smart scheduler should prioritize this content over others.</p>
        
        <h2>Another Important Heading</h2>
        <p>This paragraph is also important and should receive high priority in the translation queue. It contains meaningful content that users are likely to read first.</p>
    </div>

    <!-- 中等優先級內容 -->
    <div class="content-section medium-priority">
        <h3>Medium Priority: Secondary Content</h3>
        <p>This content has medium priority. It's important but not as critical as the content above. The scheduler should translate this after the high-priority items.</p>
        
        <p>Another medium priority paragraph with some additional information. This helps test the prioritization algorithm and ensures proper ordering.</p>
        
        <ul>
            <li>First list item with medium priority</li>
            <li>Second list item for testing</li>
            <li>Third item to verify list handling</li>
        </ul>
    </div>

    <!-- 低優先級內容 (長內容，但在視窗外) -->
    <div class="content-section low-priority">
        <h4>Lower Priority: Below the Fold Content</h4>
        <p>This content is below the fold and should have lower priority. However, it's still important enough to be translated, just not immediately.</p>
        
        <p>This is a longer paragraph that contains more detailed information. While it's valuable content, it should be translated after the more visible and important content above. The smart scheduler should handle this appropriately.</p>
        
        <p>Additional paragraph to test the scheduler's ability to handle multiple segments with different priorities. This content helps verify that the system works correctly with various content types.</p>
    </div>

    <!-- 更多測試內容 -->
    <div class="content-section">
        <h5>Additional Test Content</h5>
        <p>More test content to ensure the scheduler can handle a reasonable amount of text. This paragraph should be processed according to its calculated priority.</p>
        
        <table>
            <tr>
                <th>Column 1</th>
                <th>Column 2</th>
            </tr>
            <tr>
                <td>Table content should also be handled</td>
                <td>And prioritized appropriately</td>
            </tr>
        </table>
    </div>

    <!-- 非英文內容 (應該被過濾) -->
    <div class="content-section">
        <h6>Mixed Content Test</h6>
        <p>這是中文內容，應該被過濾掉不進行翻譯。</p>
        <p>This English content should be translated normally.</p>
        <p>Ceci est du contenu français qui devrait être filtré.</p>
    </div>

    <!-- 很短的內容 (應該被過濾) -->
    <div class="content-section">
        <p>Short</p>
        <p>This is a normal length paragraph that should be processed.</p>
        <p>OK</p>
    </div>

    <script src="js/models.js"></script>
    <script src="js/content-analyzer.js"></script>
    <script src="js/translation-renderer.js"></script>
    <script src="js/rate-limited-queue.js"></script>
    <script src="js/smart-translation-scheduler.js"></script>
    
    <script>
        // 測試變數
        let contentAnalyzer = null;
        let translationRenderer = null;
        let translationQueue = null;
        let smartScheduler = null;
        let isPaused = false;
        
        // 模擬 chrome.runtime.sendMessage
        if (typeof chrome === 'undefined') {
            window.chrome = {
                runtime: {
                    sendMessage: async (message) => {
                        await new Promise(resolve => setTimeout(resolve, 800)); // 模擬網路延遲
                        
                        if (Math.random() < 0.05) {
                            return { success: false, error: '模擬 API 錯誤' };
                        }
                        
                        return {
                            success: true,
                            translation: `[翻譯] ${message.text.substring(0, 100)}...`
                        };
                    }
                }
            };
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initializeComponents();
            setupEventListeners();
            updateStatus();
        });
        
        function initializeComponents() {
            console.log('初始化組件...');
            
            // 創建內容分析器
            contentAnalyzer = new ContentAnalyzer();
            
            // 創建翻譯渲染器
            translationRenderer = new TranslationRenderer();
            
            // 創建翻譯隊列
            translationQueue = new RateLimitedTranslationQueue({
                rpmLimit: 8, // 測試用較低限制
                tpmLimit: 50000,
                rpdLimit: 200
            });
            
            // 設定隊列回調
            translationQueue.onProgress = (progress) => {
                updateProgress(progress);
            };
            
            translationQueue.onComplete = () => {
                console.log('翻譯隊列處理完成！');
                document.getElementById('progressText').textContent = '翻譯完成！';
            };
            
            translationQueue.onError = (error, segment) => {
                console.error('翻譯錯誤:', error, segment);
            };
            
            // 創建智能排程管理器
            smartScheduler = new SmartTranslationScheduler({
                contentAnalyzer: contentAnalyzer,
                translationRenderer: translationRenderer,
                translationQueue: translationQueue
            });
            
            // 設定排程回調
            smartScheduler.onAnalysisStart = () => {
                console.log('開始分析頁面...');
                document.getElementById('analysisStatus').innerHTML = '<strong>分析狀態:</strong><br>正在分析頁面內容...';
            };
            
            smartScheduler.onAnalysisComplete = (segments) => {
                console.log('頁面分析完成:', segments);
                updateAnalysisStatus(segments);
            };
            
            smartScheduler.onSchedulingStart = (segments) => {
                console.log('開始排程翻譯...');
            };
            
            smartScheduler.onSchedulingComplete = (result) => {
                console.log('排程完成:', result);
            };
            
            smartScheduler.onError = (error) => {
                console.error('排程錯誤:', error);
            };
            
            console.log('組件初始化完成');
        }
        
        function setupEventListeners() {
            document.getElementById('analyzeBtn').addEventListener('click', analyzeContent);
            document.getElementById('scheduleBtn').addEventListener('click', startScheduling);
            document.getElementById('clearBtn').addEventListener('click', clearQueue);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
        }
        
        async function analyzeContent() {
            try {
                console.log('開始分析內容...');
                const segments = await smartScheduler.analyzeFullPage();
                console.log('分析完成，找到段落:', segments.length);
            } catch (error) {
                console.error('分析失敗:', error);
            }
        }
        
        async function startScheduling() {
            try {
                console.log('開始智能排程...');
                await smartScheduler.scheduleFullPageTranslation();
                console.log('排程完成');
            } catch (error) {
                console.error('排程失敗:', error);
            }
        }
        
        function clearQueue() {
            translationQueue.clear();
            smartScheduler.cleanup();
            updateStatus();
            document.getElementById('progressText').textContent = '隊列已清空';
            document.getElementById('progressFill').style.width = '0%';
        }
        
        function togglePause() {
            if (isPaused) {
                translationQueue.resume();
                document.getElementById('pauseBtn').textContent = '暫停';
                isPaused = false;
            } else {
                translationQueue.pause();
                document.getElementById('pauseBtn').textContent = '恢復';
                isPaused = true;
            }
        }
        
        function updateProgress(progress) {
            const percentage = progress.percentage || 0;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = 
                `進度: ${progress.current}/${progress.total} (${percentage}%) - 隊列: ${progress.queueLength}`;
            
            updateStatus();
        }
        
        function updateAnalysisStatus(segments) {
            const visibleCount = segments.filter(s => s.isVisible).length;
            const titleCount = segments.filter(s => s.type === 'title').length;
            const importantCount = segments.filter(s => s.isImportant).length;
            
            const statusHtml = `
<strong>分析狀態:</strong><br>
總段落: ${segments.length}<br>
視窗內: ${visibleCount}<br>
標題: ${titleCount}<br>
重要: ${importantCount}<br>
平均優先級: ${Math.round(segments.reduce((sum, s) => sum + s.priority, 0) / segments.length)}
            `.trim();
            
            document.getElementById('analysisStatus').innerHTML = statusHtml;
        }
        
        function updateStatus() {
            if (!translationQueue || !smartScheduler) return;
            
            const queueStatus = translationQueue.getStatus();
            const schedulingStatus = smartScheduler.getSchedulingStatus();
            
            const queueHtml = `
<strong>隊列狀態:</strong><br>
隊列長度: ${queueStatus.queueLength}<br>
已處理: ${queueStatus.processedCount}<br>
正在處理: ${queueStatus.isProcessing ? '是' : '否'}<br>
可發送請求: ${queueStatus.canSendRequest ? '是' : '否'}<br>
等待時間: ${Math.ceil(queueStatus.waitTime / 1000)}秒<br>
每日使用: ${queueStatus.dailyUsage.requests}
            `.trim();
            
            document.getElementById('queueStatus').innerHTML = queueHtml;
        }
        
        // 定期更新狀態
        setInterval(updateStatus, 2000);
    </script>
</body>
</html>