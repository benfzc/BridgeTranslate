<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Filter Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .debug-panel {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .node-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            font-family: monospace;
            font-size: 12px;
        }
        
        .node-item.filtered {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .node-item.passed {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        
        .filter-reason {
            color: #dc3545;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .node-text {
            color: #333;
            margin: 5px 0;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .node-info {
            color: #666;
            font-size: 11px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .stats {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔍 Content Filter Debug Tool</h1>
    
    <div class="stats" id="stats">
        <div>總文本節點: <span id="total-nodes">0</span></div>
        <div>通過過濾: <span id="passed-nodes">0</span></div>
        <div>被過濾: <span id="filtered-nodes">0</span></div>
        <div>過濾率: <span id="filter-rate">0%</span></div>
    </div>
    
    <button onclick="analyzeCurrentPage()">分析當前頁面</button>
    <button onclick="showOnlyFiltered()">只顯示被過濾的</button>
    <button onclick="showOnlyPassed()">只顯示通過的</button>
    <button onclick="showAll()">顯示全部</button>
    
    <div class="debug-panel" id="results">
        <p>點擊 "分析當前頁面" 開始分析...</p>
    </div>

    <!-- 載入必要的腳本 -->
    <script src="js/models.js"></script>
    <script src="js/content-analyzer.js"></script>
    <script src="js/smart-translation-scheduler.js"></script>

    <script>
        let analysisResults = [];
        
        function analyzeCurrentPage() {
            try {
                console.log('開始分析頁面內容過濾...');
                
                // 創建內容分析器
                const contentAnalyzer = new ContentAnalyzer();
                
                // 創建智能排程器 (用於過濾邏輯)
                const scheduler = new SmartTranslationScheduler({
                    contentAnalyzer: contentAnalyzer
                });
                
                // 獲取所有文本節點
                const allTextNodes = contentAnalyzer.detectTextNodes();
                console.log(`檢測到 ${allTextNodes.length} 個文本節點`);
                
                // 分析每個節點的過濾結果
                analysisResults = allTextNodes.map((node, index) => {
                    const text = node.textContent.trim();
                    const element = node.parentElement;
                    
                    // 檢查各種過濾條件
                    const checks = {
                        textLength: text.length >= 10 && text.length <= 2000,
                        isEnglish: scheduler.isEnglishText(text),
                        notExcluded: !scheduler.isExcludedElement(element),
                        notTranslated: !scheduler.isAlreadyTranslated(node)
                    };
                    
                    const passed = Object.values(checks).every(check => check);
                    
                    // 找出失敗的原因
                    const failedChecks = Object.entries(checks)
                        .filter(([key, value]) => !value)
                        .map(([key]) => key);
                    
                    return {
                        index,
                        node,
                        text: text.substring(0, 200) + (text.length > 200 ? '...' : ''),
                        fullText: text,
                        element: element,
                        tagName: element ? element.tagName : 'unknown',
                        className: element ? element.className : '',
                        checks,
                        passed,
                        failedChecks,
                        textLength: text.length,
                        englishRatio: calculateEnglishRatio(text)
                    };
                });
                
                displayResults();
                updateStats();
                
            } catch (error) {
                console.error('分析失敗:', error);
                document.getElementById('results').innerHTML = `<p style="color: red;">分析失敗: ${error.message}</p>`;
            }
        }
        
        function calculateEnglishRatio(text) {
            const englishChars = (text.match(/[a-zA-Z]/g) || []).length;
            const totalChars = text.replace(/\s/g, '').length;
            return totalChars > 0 ? (englishChars / totalChars) : 0;
        }
        
        function displayResults(filter = 'all') {
            let filteredResults = analysisResults;
            
            if (filter === 'passed') {
                filteredResults = analysisResults.filter(r => r.passed);
            } else if (filter === 'filtered') {
                filteredResults = analysisResults.filter(r => !r.passed);
            }
            
            const resultsHtml = filteredResults.map(result => {
                const cssClass = result.passed ? 'passed' : 'filtered';
                const reasonHtml = result.failedChecks.length > 0 
                    ? `<div class="filter-reason">過濾原因: ${result.failedChecks.join(', ')}</div>`
                    : '';
                
                return `
                    <div class="node-item ${cssClass}">
                        <div class="node-info">
                            節點 ${result.index} | 標籤: ${result.tagName} | 類名: ${result.className || '無'} | 
                            長度: ${result.textLength} | 英文比例: ${(result.englishRatio * 100).toFixed(1)}%
                        </div>
                        <div class="node-text">${result.text}</div>
                        ${reasonHtml}
                    </div>
                `;
            }).join('');
            
            document.getElementById('results').innerHTML = resultsHtml || '<p>沒有符合條件的結果</p>';
        }
        
        function updateStats() {
            const total = analysisResults.length;
            const passed = analysisResults.filter(r => r.passed).length;
            const filtered = total - passed;
            const filterRate = total > 0 ? ((filtered / total) * 100).toFixed(1) : 0;
            
            document.getElementById('total-nodes').textContent = total;
            document.getElementById('passed-nodes').textContent = passed;
            document.getElementById('filtered-nodes').textContent = filtered;
            document.getElementById('filter-rate').textContent = filterRate + '%';
        }
        
        function showOnlyFiltered() {
            displayResults('filtered');
        }
        
        function showOnlyPassed() {
            displayResults('passed');
        }
        
        function showAll() {
            displayResults('all');
        }
        
        // 自動分析當前頁面
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(analyzeCurrentPage, 1000);
        });
    </script>
</body>
</html>